<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin-layout}">

<head>
  <title layout:title-pattern="Project Details - %s" th:text="${project.name}">Project Detail</title>
</head>

<body>

<section layout:fragment="content">

  <div class="content-header">
    <div>
      <h1>
        <span th:text="${project.name}">Project Name</span>
        <span style="font-size: 0.6em; color: #6c757d; font-weight: normal;" th:text="'(' + ${project.abbreviation} + ')'"></span>
      </h1>
    </div>
    <div class="header-actions">
      <a th:href="@{/admin/projects}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back
      </a>

      <a th:href="@{/admin/projects/edit/{id}(id=${project.id})}" class="btn btn-primary">
        <i class="fas fa-edit"></i> Edit
      </a>

      <form th:action="@{/admin/projects/delete/{id}(id=${project.id})}" method="post" style="display: inline;">
        <button type="submit"
                class="btn btn-secondary"
                style="background: #e74c3c;"
                th:title="${(project.status.toString() == 'COMPLETED' or project.status.toString() == 'CANCELLED') ? 'Cannot delete completed or cancelled project' : 'Delete Project'}"
                th:data-project-name="${project.name}"
                th:disabled="${project.status.toString() == 'COMPLETED' or project.status.toString() == 'CANCELLED'}"
                onclick="return confirm('Bạn có chắc chắn muốn huỷ dự án \'' + this.getAttribute('data-project-name') + '\' không? Hành động này sẽ vô hiệu hoá các thành viên.');">
          <i class="fas fa-trash"></i> Delete
        </button>
      </form>
    </div>
  </div>

  <div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">

    <div style="flex: 2; min-width: 300px;">

      <div class="card">
        <div class="card-header">
          <h6>General Information</h6>
        </div>
        <div class="form-grid" style="margin-top: 15px;">
          <div>
            <div class="info-label">Team</div>
            <div class="info-value" th:text="${project.teamName}">Team Name</div>
          </div>
          <div>
            <div class="info-label">Duration</div>
            <div class="info-value">
              <i class="far fa-calendar-alt"></i>
              <span th:text="${project.startDate}"></span>
              <span>→</span>
              <span th:text="${project.endDate != null ? project.endDate : 'Ongoing'}"></span>
            </div>
          </div>
          <div>
            <div class="info-label">Created At</div>
            <div class="info-value" th:text="${#temporals.format(project.createdAt, 'dd-MM-yyyy HH:mm')}"></div>
          </div>
          <div>
            <div class="info-label">Last Updated</div>
            <div class="info-value" th:text="${#temporals.format(project.updatedAt, 'dd-MM-yyyy HH:mm')}"></div>
          </div>
        </div>
      </div>

      <div class="table-container">
        <div style="padding: 15px; border-bottom: 2px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="font-size: 1.25rem; color: #2c3e50; font-weight: 600; margin: 0;">Project Members</h2>

          <div style="display: flex; align-items: center; gap: 10px;">
            <form id="pageSizeForm" method="get" th:action="@{/admin/projects/{id}(id=${project.id})}" style="margin: 0;">
              <input type="hidden" name="page" value="0"/>
              <input type="hidden" name="sortField" th:value="${sortField}"/>
              <input type="hidden" name="sortDir" th:value="${sortDir}"/>

              <select name="size" class="form-control"
                      style="padding: 5px 10px; width: auto; font-size: 0.9rem;"
                      onchange="document.getElementById('pageSizeForm').submit();">
                <option th:each="s : ${pageSizeOptions}"
                        th:value="${s}"
                        th:selected="${currentPageSize == s}"
                        th:text="${s}"></option>
              </select>
            </form>
            <span class="badge badge-info" th:text="${memberPage.totalElements}">0</span>
          </div>
        </div>

        <table class="user-table">
          <thead>
          <tr>
            <th>
              <a th:href="@{/admin/projects/{id}(id=${project.id}, page=${memberPage.number}, size=${currentPageSize}, sortField='user.name', sortDir=${sortField == 'user.name' ? reverseSortDir : 'asc'})}"
                 class="sort-link" style="color: white;">
                Member
                <i class="fas"
                   th:classappend="${sortField == 'user.name' ? (sortDir == 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}"
                   style="margin-left: 5px; opacity: 0.7;"></i>
              </a>
            </th>

            <th>
              <a th:href="@{/admin/projects/{id}(id=${project.id}, page=${memberPage.number}, size=${currentPageSize}, sortField='joinedAt', sortDir=${sortField == 'joinedAt' ? reverseSortDir : 'asc'})}"
                 class="sort-link" style="color: white;">
                Joined Date
                <i class="fas"
                   th:classappend="${sortField == 'joinedAt' ? (sortDir == 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}"
                   style="margin-left: 5px; opacity: 0.7;"></i>
              </a>
            </th>

            <th>
              <a th:href="@{/admin/projects/{id}(id=${project.id}, page=${memberPage.number}, size=${currentPageSize}, sortField='status', sortDir=${sortField == 'status' ? reverseSortDir : 'asc'})}"
                 class="sort-link" style="color: white;">
                Status
                <i class="fas"
                   th:classappend="${sortField == 'status' ? (sortDir == 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}"
                   style="margin-left: 5px; opacity: 0.7;"></i>
              </a>
            </th>

            <th class="text-center">Actions</th>
          </tr>
          </thead>
          <tbody>
          <tr th:if="${memberPage.content.isEmpty()}">
            <td colspan="4" style="text-align: center; padding: 20px; color: #7f8c8d;">
              No members found.
            </td>
          </tr>
          <tr th:each="member : ${memberPage.content}">
            <td>
              <div class="member-info">
                <span class="member-name" th:text="${member.userName}">Name</span>
                <span class="member-email" th:text="${member.userEmail}">Email</span>
              </div>
            </td>
            <td th:text="${#temporals.format(member.joinedAt, 'dd-MM-yyyy')}"></td>
            <td>
                 <span th:class="|badge ${member.status == 'ACTIVE' ? 'badge-success' : 'badge-secondary'}|"
                       th:text="${member.status}"></span>
            </td>
            <td class="action-buttons" style="justify-content: center;">
              <a th:href="@{/admin/users/{id}(id=${member.userId})}" class="btn-icon btn-view" title="View">
                <i class="fas fa-eye"></i>
              </a>
              <a th:href="@{/admin/projects/{pid}/members/{mid}/remove(pid=${project.id},mid=${member.id})}"
                 class="btn-icon btn-delete"
                 onclick="return confirm('Are you sure you want to remove this member?');"
                 title="Remove">
                <i class="fas fa-trash"></i>
              </a>
            </td>
          </tr>
          </tbody>
        </table>

        <div class="pagination-container" th:if="${memberPage.totalPages > 1}" style="border-radius: 0 0 10px 10px; box-shadow: none;">
          <div class="pagination">
            <a th:href="@{/admin/projects/{id}(id=${project.id}, page=0, size=${currentPageSize}, sortField=${sortField}, sortDir=${sortDir})}"
               class="page-link"
               th:classappend="${memberPage.number == 0 ? 'disabled' : ''}">
              <i class="fas fa-angle-double-left"></i>
            </a>

            <a th:href="@{/admin/projects/{id}(id=${project.id}, page=${memberPage.number - 1}, size=${currentPageSize}, sortField=${sortField}, sortDir=${sortDir})}"
               class="page-link"
               th:classappend="${memberPage.number == 0 ? 'disabled' : ''}">
              <i class="fas fa-angle-left"></i>
            </a>

            <th:block th:with="totalPages=${memberPage.totalPages}, currentPage=${memberPage.number}">
              <th:block th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}">
                <a th:if="${pageNum < 2 || pageNum >= totalPages - 2 || (pageNum >= currentPage - 1 && pageNum <= currentPage + 1)}"
                   th:href="@{/admin/projects/{id}(id=${project.id}, page=${pageNum}, size=${currentPageSize}, sortField=${sortField}, sortDir=${sortDir})}"
                   class="page-link"
                   th:classappend="${pageNum == currentPage ? 'active' : ''}"
                   th:text="${pageNum + 1}">1</a>

                <span th:if="${pageNum == 2 and currentPage > 3}" class="page-ellipsis">...</span>
                <span th:if="${pageNum == totalPages - 3 and currentPage < totalPages - 4}" class="page-ellipsis">...</span>
              </th:block>
            </th:block>

            <a th:href="@{/admin/projects/{id}(id=${project.id}, page=${memberPage.number + 1}, size=${currentPageSize}, sortField=${sortField}, sortDir=${sortDir})}"
               class="page-link"
               th:classappend="${memberPage.number >= memberPage.totalPages - 1 ? 'disabled' : ''}">
              <i class="fas fa-angle-right"></i>
            </a>

            <a th:href="@{/admin/projects/{id}(id=${project.id}, page=${memberPage.totalPages - 1}, size=${currentPageSize}, sortField=${sortField}, sortDir=${sortDir})}"
               class="page-link"
               th:classappend="${memberPage.number >= memberPage.totalPages - 1 ? 'disabled' : ''}">
              <i class="fas fa-angle-double-right"></i>
            </a>
          </div>
          <div class="pagination-info">
            Page <strong th:text="${memberPage.number + 1}">1</strong> of <strong th:text="${memberPage.totalPages}">10</strong>
          </div>
        </div>
      </div>
    </div>

    <div style="flex: 1; min-width: 250px;">
      <div class="card">
        <div class="card-header">
          <h6>Leadership History</h6>
        </div>
        <div style="padding: 1.5rem;">
          <div th:if="${project.leadershipHistory.isEmpty()}" style="text-align: center; color: #7f8c8d; padding: 20px 0;">
            <i class="fas fa-user-tie" style="font-size: 2em; margin-bottom: 10px; display: block;"></i>
            No history recorded.
          </div>

          <div th:unless="${project.leadershipHistory.isEmpty()}">
            <div th:each="leader : ${project.leadershipHistory}"
                 th:class="${leader.current ? 'leadership-item current' : 'leadership-item'}">

              <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85em;">
                <small th:if="${leader.current}" style="color: #28a745; font-weight: bold;">
                  <i class="fas fa-check-circle"></i> Current
                </small>
                <small th:unless="${leader.current}" style="color: #6c757d; font-weight: bold;">
                  <i class="fas fa-history"></i> Former
                </small>
                <small style="color: #6c757d;">
                  <span th:text="${#temporals.format(leader.startedAt, 'MMM yyyy')}"></span> -
                  <span th:if="${leader.endedAt != null}" th:text="${#temporals.format(leader.endedAt, 'MMM yyyy')}"></span>
                  <span th:if="${leader.endedAt == null}">Present</span>
                </small>
              </div>

              <div style="font-weight: 600; color: #2c3e50; margin-bottom: 2px;" th:text="${leader.leaderName}">Leader Name</div>
              <div style="font-size: 0.9em; color: #6c757d;">
                <i class="fas fa-envelope"></i> <span th:text="${leader.leaderEmail}">email@example.com</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
</body>
</html>